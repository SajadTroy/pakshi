require('dotenv').config();
const { Client, GatewayIntentBits, SlashCommandBuilder, REST, Routes, EmbedBuilder, ActivityType } = require('discord.js');
const mongoose = require('mongoose');
const Sentiment = require('sentiment');
const User = require('./models/User');

// Initialize Discord client with necessary intents
const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,
    GatewayIntentBits.GuildMembers
  ]
});

// Connect to MongoDB
mongoose.connect(process.env.MONGODB_URI, { useNewUrlParser: true, useUnifiedTopology: true })
  .then(() => console.log('Connected to MongoDB'))
  .catch(err => console.error('MongoDB connection error:', err));

// Slash command collection
client.commands = new Map();

// Define /help slash command
const helpCommand = new SlashCommandBuilder()
  .setName('help')
  .setDescription('Learn how to use the Aura Bot and its commands.');

client.commands.set(helpCommand.name, {
  data: helpCommand,
  async execute(interaction) {
    const embed = new EmbedBuilder()
      .setTitle('üåå Aura Bot Help')
      .setDescription(
        'The Aura Bot calculates and visualizes your spiritual and Gen Z aura based on your chat messages in English, Malayalam, Manglish, and Hindi. Your aura reflects your vibe, personality, and energy, stored as aura points (-100 to +100).'
      )
      .addFields(
        {
          name: 'Commands',
          value: `
            **/help** - Show this help message.
            **;aura @user** - Check a user's aura points and vibe (e.g., ;aura @JohnDoe).
            **;visualize @user** - Visualize a user's aura with chakra alignment and multilingual flair (e.g., ;visualize @JohnDoe).
          `
        },
        {
          name: 'How Aura Works',
          value: 'Aura points are calculated from your messages using sentiment analysis and keywords (e.g., "santhosham," "‡§ñ‡•Å‡§∂‡•Ä," "vibe-check"). Positive words (+15 points) and negative words (-15 points) shape your aura, smoothed over time.'
        },
        {
          name: 'Visualization',
          value: 'The ;visualize command describes your aura as a glowing energy field, tied to a chakra (e.g., crown for positive vibes, root for negative). It includes Gen Z slang and multilingual vibes (e.g., "poli," "mast").'
        },
        {
          name: 'Languages Supported',
          value: 'English, Malayalam (‡¥∏‡¥®‡µç‡¥§‡µã‡¥∑‡¥Ç), Manglish (santhosham), Hindi (‡§ñ‡•Å‡§∂‡•Ä). Use spiritual or Gen Z terms to influence your aura!'
        }
      )
      .setColor(0x00B7EB)
      .setTimestamp();

    await interaction.reply({ embeds: [embed] });
  }
});

// Register slash commands
const rest = new REST({ version: '10' }).setToken(process.env.DISCORD_TOKEN);

async function registerSlashCommands() {
  try {
    console.log('Registering slash commands...');
    await rest.put(
      Routes.applicationCommands(process.env.CLIENT_ID), // Global commands
      { body: [helpCommand.toJSON()] }
    );
    console.log('Slash commands registered successfully.');
  } catch (error) {
    console.error('Error registering slash commands:', error);
  }
}

// Aura calculation function with multilingual keywords
function calculateSpiritualAuraPoints(text) {
  if (!text || typeof text !== 'string' || text.trim() === '') {
    return 0; // Neutral aura for empty/invalid input
  }

  const sentiment = new Sentiment();
  const result = sentiment.analyze(text);
  const sentimentScore = result.score;

  // Multilingual aura keywords (English, Malayalam, Manglish, Hindi)
  const positiveAuraWords = [
    // English spiritual terms
    'joy', 'love', 'compassion', 'kindness', 'peace', 'gratitude', 'healing', 'light', 'blessing', 'hope',
    'serenity', 'divine', 'harmony', 'wisdom', 'empathy', 'grace', 'radiance', 'tranquility', 'unity', 'forgiveness',
    'inspiration', 'clarity', 'purity', 'zen', 'soulful', 'uplifting', 'sacred', 'bliss', 'devotion', 'awe',
    // English niche spiritual terms
    'chakra', 'cosmic', 'kundalini', 'aura', 'enlightenment', 'ascension', 'vibration', 'starseed', 'manifest', 'aligned',
    'third-eye', 'satori', 'nirvana', 'prana', 'shakti', 'etheric', 'astral', 'divinity', 'samadhi', 'lightworker',
    'kismet', 'synchronicity', 'arcane', 'mystic', 'esoteric',
    // English Gen Z slang
    'slay', 'vibes', 'iconic', 'real', 'authentic', 'queen', 'king', 'stan', 'inspo', 'bussin',
    'fire', 'lit', 'goat', 'legend', 'vibe', 'glow', 'energy', 'main-character', 'pop-off', 'bet',
    'fam', 'hype', 'drip', 'snack', 'yass', 'secure-the-bag', 'on-fleek', 'extra', 'thriving', 'w',
    // English niche Gen Z slang
    'sksksk', 'periodt', 'vibe-check', 'and-i-oop', 'tea', 'serving', 'looks', 'snatched', 'big-yikes', 'slaps',
    'no-skip', 'giving-life', 'mood', 'aesthetic', 'lowkey-w', 'highkey-iconic', 'bop', 'it-hits-different', 'chef-kiss', 'sheesh',
    // Malayalam spiritual/emotional terms
    '‡¥∏‡¥®‡µç‡¥§‡µã‡¥∑‡¥Ç', '‡¥∏‡µç‡¥®‡µá‡¥π‡¥Ç', '‡¥ï‡¥∞‡µÅ‡¥£', '‡¥¶‡¥Ø', '‡¥∏‡¥Æ‡¥æ‡¥ß‡¥æ‡¥®‡¥Ç', '‡¥®‡¥®‡µç‡¥¶‡¥ø', '‡¥∞‡µã‡¥ó‡¥∂‡¥æ‡¥®‡µç‡¥§‡¥ø', '‡¥µ‡µÜ‡¥≥‡¥ø‡¥ö‡µç‡¥ö‡¥Ç', '‡¥Ü‡¥∂‡µÄ‡µº‡¥µ‡¥æ‡¥¶‡¥Ç', '‡¥™‡µç‡¥∞‡¥§‡µÄ‡¥ï‡µç‡¥∑',
    '‡¥∂‡¥æ‡¥®‡µç‡¥§‡¥ø', '‡¥¶‡µà‡¥µ‡¥ø‡¥ï', '‡¥ê‡¥ï‡µç‡¥Ø‡¥Ç', '‡¥ú‡µç‡¥û‡¥æ‡¥®‡¥Ç', '‡¥∏‡¥π‡¥æ‡¥®‡µÅ‡¥≠‡µÇ‡¥§‡¥ø', '‡¥ï‡µÉ‡¥™', '‡¥§‡µá‡¥ú‡¥∏‡µç‡¥∏‡µç', '‡¥®‡¥ø‡¥∂‡µç‡¥ö‡¥≤‡¥§', '‡¥è‡¥ï‡¥§', '‡¥ï‡µç‡¥∑‡¥Æ',
    '‡¥Ü‡¥§‡µç‡¥Æ‡¥æ‡¥µ‡µç', '‡¥®‡¥®‡µç‡¥Æ', '‡¥µ‡¥ø‡¥∂‡µÅ‡¥¶‡µç‡¥ß‡¥ø', '‡¥™‡µç‡¥∞‡¥ö‡µã‡¥¶‡¥®‡¥Ç', '‡¥µ‡¥ø‡¥Æ‡µã‡¥ö‡¥®‡¥Ç',
    // Malayalam niche spiritual terms
    '‡¥ö‡¥ï‡µç‡¥∞‡¥Ç', '‡¥¨‡µç‡¥∞‡¥π‡µç‡¥Æ‡¥æ‡¥£‡µç‡¥°‡¥Ç', '‡¥ï‡µÅ‡¥£‡µç‡¥°‡¥≤‡¥ø‡¥®‡¥ø', '‡¥ì‡¥±', '‡¥Æ‡µã‡¥ï‡µç‡¥∑‡¥Ç', '‡¥Ü‡¥∞‡µã‡¥π‡¥£‡¥Ç', '‡¥∏‡µç‡¥™‡¥®‡µç‡¥¶‡¥®‡¥Ç', '‡¥®‡¥ï‡µç‡¥∑‡¥§‡µç‡¥∞‡¥¨‡µÄ‡¥ú‡¥Ç', '‡¥™‡µç‡¥∞‡¥ï‡¥ü‡¥®‡¥Ç', '‡¥∏‡¥Æ‡¥®‡µç‡¥µ‡¥Ø‡¥Ç',
    '‡¥®‡µÜ‡¥±‡µç‡¥±‡¥ø‡¥ö‡¥ï‡µç‡¥∞‡¥Ç', '‡¥®‡¥ø‡µº‡¥µ‡¥æ‡¥£‡¥Ç', '‡¥™‡µç‡¥∞‡¥æ‡¥£‡µª', '‡¥∂‡¥ï‡µç‡¥§‡¥ø', '‡¥®‡µÄ‡¥≤‡¥æ‡¥ï‡¥æ‡¥∂‡¥Ç', '‡¥®‡¥ï‡µç‡¥∑‡¥§‡µç‡¥∞‡¥≤‡µã‡¥ï‡¥Ç', '‡¥¶‡¥ø‡¥µ‡µç‡¥Ø‡¥§', '‡¥∏‡¥Æ‡¥æ‡¥ß‡¥ø', '‡¥µ‡µÜ‡¥≥‡¥ø‡¥ö‡µç‡¥ö‡¥™‡µç‡¥∞‡¥µ‡µº‡¥§‡µç‡¥§‡¥ï‡µª',
    // Manglish spiritual/emotional terms
    'santhosham', 'sneham', 'karuna', 'daya', 'samadhanam', 'nandi', 'rogashanthi', 'velicham', 'ashirvad', 'pratheeksha',
    'shanthi', 'daivika', 'aikyam', 'jnanam', 'sahanubhuthi', 'kripa', 'tejas', 'nishchalatha', 'ekatha', 'kshama',
    'athma', 'nanma', 'vishudhi', 'prachodanam', 'vimochanam',
    // Manglish niche spiritual terms
    'chakram', 'brahmandam', 'kundalini', 'aura', 'moksham', 'aarohanam', 'spandanam', 'nakshatrabeejam', 'praktanam', 'samanwayam',
    'netti-chakram', 'nirvanam', 'pranan', 'shakthi', 'neelakasham', 'nakshatralokam', 'divyatha', 'samadhi', 'velichapravarthakan',
    // Manglish Gen Z slang
    'poli', 'vibe', 'kidu', 'mass', 'super', 'adipoli', 'thara', 'jolly', 'chumma', 'fire',
    'litty', 'goat', 'epic', 'slay', 'onnu-onnu', 'pinnallae', 'katta', 'vibes', 'thirichu', 'nalla',
    // Hindi spiritual/emotional terms
    '‡§ñ‡•Å‡§∂‡•Ä', '‡§™‡•ç‡§Ø‡§æ‡§∞', '‡§ï‡§∞‡•Å‡§£‡§æ', '‡§¶‡§Ø‡§æ', '‡§∂‡§æ‡§Ç‡§§‡§ø', '‡§ï‡•É‡§§‡§ú‡•ç‡§û‡§§‡§æ', '‡§â‡§™‡§ö‡§æ‡§∞', '‡§™‡•ç‡§∞‡§ï‡§æ‡§∂', '‡§Ü‡§∂‡•Ä‡§∞‡•ç‡§µ‡§æ‡§¶', '‡§Ü‡§∂‡§æ',
    '‡§∂‡§æ‡§®‡•ç‡§§‡§ø', '‡§¶‡§ø‡§µ‡•ç‡§Ø', '‡§è‡§ï‡§§‡§æ', '‡§ú‡•ç‡§û‡§æ‡§®', '‡§∏‡§π‡§æ‡§®‡•Å‡§≠‡•Ç‡§§‡§ø', '‡§ï‡•É‡§™‡§æ', '‡§§‡•á‡§ú', '‡§®‡§ø‡§∂‡•ç‡§ö‡§≤‡§§‡§æ', '‡§∏‡§æ‡§Æ‡§Ç‡§ú‡§∏‡•ç‡§Ø', '‡§ï‡•ç‡§∑‡§Æ‡§æ',
    '‡§Ü‡§§‡•ç‡§Æ‡§æ', '‡§∏‡§¶‡•ç‡§≠‡§æ‡§µ', '‡§™‡§µ‡§ø‡§§‡•ç‡§∞‡§§‡§æ', '‡§™‡•ç‡§∞‡•á‡§∞‡§£‡§æ', '‡§Æ‡•Å‡§ï‡•ç‡§§‡§ø',
    // Hindi niche spiritual terms
    '‡§ö‡§ï‡•ç‡§∞', '‡§¨‡•ç‡§∞‡§π‡•ç‡§Æ‡§æ‡§Ç‡§°‡•Ä‡§Ø', '‡§ï‡•Å‡§Ç‡§°‡§≤‡§ø‡§®‡•Ä', '‡§Ü‡§≠‡§æ', '‡§Æ‡•ã‡§ï‡•ç‡§∑', '‡§â‡§§‡•ç‡§•‡§æ‡§®', '‡§ï‡§Ç‡§™‡§®', '‡§®‡§ï‡•ç‡§∑‡§§‡•ç‡§∞‡§¨‡•Ä‡§ú', '‡§™‡•ç‡§∞‡§ï‡§ü‡•Ä‡§ï‡§∞‡§£', '‡§∏‡§Ç‡§®‡§æ‡§¶',
    '‡§§‡•É‡§§‡•Ä‡§Ø-‡§®‡•á‡§§‡•ç‡§∞', '‡§®‡§ø‡§∞‡•ç‡§µ‡§æ‡§£', '‡§™‡•ç‡§∞‡§æ‡§£', '‡§∂‡§ï‡•ç‡§§‡§ø', '‡§Ü‡§ï‡§æ‡§∂‡•Ä‡§Ø', '‡§®‡§ï‡•ç‡§∑‡§§‡•ç‡§∞‡§≤‡•ã‡§ï', '‡§¶‡§ø‡§µ‡•ç‡§Ø‡§§‡§æ', '‡§∏‡§Æ‡§æ‡§ß‡§ø', '‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§ï‡§∞‡•ç‡§Æ‡•Ä',
    // Hindi Gen Z slang
    'banger', 'lit', 'vibe', 'slay', 'fire', 'epic', 'boss', 'dil-se-dil', 'mast', 'jhakaas',
    'dhamaka', 'fatafati', 'zabardast', 'killer', 'on-point', 'desi-swag', 'bawaal', 'sahi', 'full-on', 'tadka'
  ];
  const negativeAuraWords = [
    // English spiritual terms
    'hate', 'anger', 'fear', 'sadness', 'toxic', 'dark', 'curse', 'jealousy', 'resentment', 'pain',
    'malice', 'dread', 'spite', 'grudge', 'sorrow', 'despair', 'negativity', 'bitterness', 'torment', 'envy',
    'chaos', 'disharmony', 'anguish', 'vile', 'gloom', 'misery', 'wrath', 'deceit', 'suffering', 'doom',
    // English niche spiritual terms
    'stagnation', 'karmic-debt', 'shadow', 'blockage', 'lower-vibration', 'discord', 'hex', 'jinx', 'malevolent', 'haunted',
    'eclipsed', 'astral-trap', 'soul-drain', 'void', 'dissonance', 'baneful', 'obscured', 'tainted', 'unaligned', 'cursed',
    // English Gen Z slang
    'cringe', 'fake', 'shady', 'sus', 'drama', 'messy', 'mid', 'clout-chaser', 'flop', 'basic',
    'salty', 'pressed', 'lame', 'ratio', 'cap', 'no-cap', 'ghosted', 'canceled', 'tea-spiller', 'try-hard',
    'extra-in-a-bad-way', 'lowkey-toxic', 'vibe-killer', 'problematic', 'red-flag', 'ick', 'overrated', 'done',
    // English niche Gen Z slang
    'oop', 'flopped', 'giving-ick', 'big-yikes', 'tea-spilled', 'ratioed', 'delulu', 'situationship', 'fumbled', 'zesty',
    'unserious', 'not-the-vibe', 'off-brand', 'giving-side-eye', 'cooked', 'out-of-pocket', 'no-maam', 'left-on-read', 'tragic', 'skipped',
    // Malayalam spiritual/emotional terms
    '‡¥µ‡µÜ‡¥±‡µÅ‡¥™‡µç‡¥™‡µç', '‡¥¶‡µá‡¥∑‡µç‡¥Ø‡¥Ç', '‡¥≠‡¥Ø‡¥Ç', '‡¥µ‡¥ø‡¥∑‡¥æ‡¥¶‡¥Ç', '‡¥µ‡¥ø‡¥∑‡¥Æ‡¥Ø‡¥Ç', '‡¥á‡¥∞‡µÅ‡¥ü‡µç‡¥ü‡µç', '‡¥∂‡¥æ‡¥™‡¥Ç', '‡¥Ö‡¥∏‡µÇ‡¥Ø', '‡¥™‡¥ï', '‡¥µ‡µá‡¥¶‡¥®',
    '‡¥¶‡µÅ‡¥∞‡µÅ‡¥¶‡µç‡¥¶‡µá‡¥∂‡µç‡¥Ø‡¥Ç', '‡¥≠‡µÄ‡¥§‡¥ø', '‡¥®‡¥ø‡¥®‡µç‡¥¶', '‡¥™‡¥ø‡¥£‡¥ï‡µç‡¥ï‡¥Ç', '‡¥¶‡µÅ‡¥É‡¥ñ‡¥Ç', '‡¥®‡¥ø‡¥∞‡¥æ‡¥∂', '‡¥®‡µÜ‡¥ó‡¥±‡µç‡¥±‡¥ø‡¥µ‡¥ø‡¥±‡µç‡¥±‡¥ø', '‡¥ï‡¥Ø‡µç‡¥™‡µç', '‡¥™‡µÄ‡¥°‡¥®‡¥Ç', '‡¥à‡µº‡¥∑‡µç‡¥Ø',
    '‡¥ï‡µÅ‡¥¥‡¥™‡µç‡¥™‡¥Ç', '‡¥Ö‡¥∏‡¥®‡µç‡¥§‡µÅ‡¥≤‡¥ø‡¥§', '‡¥µ‡µç‡¥Ø‡¥•', '‡¥®‡µÄ‡¥ö‡¥Ç', '‡¥ó‡µç‡¥≤‡µÇ‡¥Ç', '‡¥¶‡µÅ‡¥∞‡¥ø‡¥§‡¥Ç', '‡¥ï‡µç‡¥∞‡µã‡¥ß‡¥Ç', '‡¥µ‡¥û‡µç‡¥ö‡¥®', '‡¥ï‡¥∑‡µç‡¥ü‡¥™‡µç‡¥™‡¥æ‡¥ü‡µç', '‡¥µ‡¥ø‡¥®‡¥æ‡¥∂‡¥Ç',
    // Malayalam niche spiritual terms
    '‡¥®‡¥ø‡¥∂‡µç‡¥ö‡¥≤‡¥§', '‡¥ï‡µº‡¥Æ‡µç‡¥Æ‡¥¨‡¥æ‡¥ß', '‡¥®‡¥ø‡¥¥‡µΩ', '‡¥§‡¥ü‡¥∏‡µç‡¥∏‡¥Ç', '‡¥§‡¥æ‡¥¥‡µç‡¥®‡µç‡¥®-‡¥∏‡µç‡¥™‡¥®‡µç‡¥¶‡¥®‡¥Ç', '‡¥µ‡¥ø‡¥Ø‡µã‡¥ú‡¥ø‡¥™‡µç‡¥™‡µç', '‡¥∂‡¥æ‡¥™‡¥ó‡µç‡¥∞‡¥∏‡µç‡¥§', '‡¥¶‡µã‡¥∑‡¥Ç', '‡¥¶‡µÅ‡¥∑‡µç‡¥ü', '‡¥™‡µá‡¥ü‡¥ø‡¥∏‡µç‡¥µ‡¥™‡µç‡¥®‡¥Ç',
    '‡¥ó‡µç‡¥∞‡¥π‡¥£‡¥Ç', '‡¥®‡¥ï‡µç‡¥∑‡¥§‡µç‡¥∞-‡¥ï‡µÜ‡¥£‡¥ø', '‡¥Ü‡¥§‡µç‡¥Æ-‡¥®‡¥æ‡¥∂‡¥Ç', '‡¥∂‡µÇ‡¥®‡µç‡¥Ø‡¥§', '‡¥µ‡¥ø‡¥∏‡¥®‡µç‡¥§‡µÅ‡¥≤‡¥®‡¥Ç', '‡¥®‡¥ø‡¥®‡µç‡¥¶‡¥®‡µÄ‡¥Ø‡¥Ç', '‡¥Æ‡¥ô‡µç‡¥ô‡¥ø‡¥Ø', '‡¥Æ‡¥≤‡¥ø‡¥®‡¥Ç', '‡¥µ‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥™‡µã‡¥ï‡µΩ', '‡¥∂‡¥™‡¥ø‡¥ï‡µç‡¥ï‡¥™‡µç‡¥™‡µÜ‡¥ü‡µç‡¥ü',
    // Manglish spiritual/emotional terms
    'veruppu', 'deshyam', 'bhayam', 'vishadam', 'vishamayam', 'iruttu', 'shapam', 'asooya', 'paka', 'vedana',
    'duruddeshyam', 'bheethi', 'ninda', 'pinakkam', 'dukham', 'nirasha', 'negativity', 'kaipp', 'peedanam', 'irshya',
    'kuzhappam', 'asanthulitha', 'vyatha', 'neecham', 'gloom', 'duritham', 'krodham', 'vanchanam', 'kashtapad', 'vinasham',
    // Manglish niche spiritual terms
    'nishchalatha', 'karmabhaada', 'nizhal', 'thadassam', 'thaazhnna-spandanam', 'viyojipp', 'shapagrasta', 'dosham', 'dushta', 'pediswapnam',
    'grahanam', 'nakshatrakeni', 'athmanasham', 'shoonyatha', 'visanthulanam', 'nindaneeyam', 'mangiya', 'malinam', 'vittupokkal', 'shapikkapetta',
    // Manglish Gen Z slang
    'thallu', 'bakwas', 'cringe', 'vatt', 'drama', 'kuzhappam', 'mid', 'fake', 'shady', 'sus',
    'chali', 'venda', 'lame', 'flop', 'bore', 'irritating', 'over', 'no-way', 'chumma-vatt', 'pottan',
    // Hindi spiritual/emotional terms
    '‡§®‡§´‡§∞‡§§', '‡§ó‡•Å‡§∏‡•ç‡§∏‡§æ', '‡§°‡§∞', '‡§â‡§¶‡§æ‡§∏‡•Ä', '‡§µ‡§ø‡§∑‡§æ‡§ï‡•ç‡§§', '‡§Ö‡§Ç‡§ß‡•á‡§∞‡§æ', '‡§∂‡§æ‡§™', '‡§à‡§∞‡•ç‡§∑‡•ç‡§Ø‡§æ', '‡§¶‡•ç‡§µ‡•á‡§∑', '‡§¶‡§∞‡•ç‡§¶',
    '‡§¶‡•Å‡§∞‡•ç‡§≠‡§æ‡§µ‡§®‡§æ', '‡§≠‡§Ø', '‡§®‡§ø‡§Ç‡§¶‡§æ', '‡§Æ‡§®‡§Æ‡•Å‡§ü‡§æ‡§µ', '‡§¶‡•Å‡§ñ', '‡§®‡§ø‡§∞‡§æ‡§∂‡§æ', '‡§®‡§ï‡§æ‡§∞‡§æ‡§§‡•ç‡§Æ‡§ï‡§§‡§æ', '‡§ï‡§ü‡•Å‡§§‡§æ', '‡§Ø‡§æ‡§§‡§®‡§æ', '‡§¶‡•ç‡§µ‡•á‡§∑',
    '‡§Ö‡§∞‡§æ‡§ú‡§ï‡§§‡§æ', '‡§Ö‡§∏‡§æ‡§Æ‡§Ç‡§ú‡§∏‡•ç‡§Ø', '‡§™‡•Ä‡§°‡§º‡§æ', '‡§®‡•Ä‡§ö', '‡§â‡§¶‡§æ‡§∏‡•Ä‡§®‡§§‡§æ', '‡§¶‡•Å‡§∞‡§ø‡§§‡§æ', '‡§ï‡•ç‡§∞‡•ã‡§ß', '‡§ß‡•ã‡§ñ‡§æ', '‡§ï‡§∑‡•ç‡§ü', '‡§µ‡§ø‡§®‡§æ‡§∂',
    // Hindi niche spiritual terms
    '‡§†‡§π‡§∞‡§æ‡§µ', '‡§ï‡§∞‡•ç‡§Æ-‡§ã‡§£', '‡§õ‡§æ‡§Ø‡§æ', '‡§∞‡•Å‡§ï‡§æ‡§µ‡§ü', '‡§®‡§ø‡§Æ‡•ç‡§®-‡§ï‡§Ç‡§™‡§®', '‡§µ‡§ø‡§∏‡§Ç‡§ó‡§§‡§ø', '‡§π‡•à‡§ï‡•ç‡§∏', '‡§úinx', '‡§¶‡•Å‡§∑‡•ç‡§ü', '‡§≠‡•Ç‡§§‡§ø‡§Ø‡§æ',
    '‡§ó‡•ç‡§∞‡§π‡§£', '‡§®‡§ï‡•ç‡§∑‡§§‡•ç‡§∞-‡§ú‡§æ‡§≤', '‡§Ü‡§§‡•ç‡§Æ-‡§®‡§æ‡§∂', '‡§∂‡•Ç‡§®‡•ç‡§Ø‡§§‡§æ', '‡§Ö‡§∏‡§Ç‡§§‡•Å‡§≤‡§®', '‡§®‡§ø‡§Ç‡§¶‡§®‡•Ä‡§Ø', '‡§ß‡•Å‡§Ç‡§ß‡§≤‡§æ', '‡§¶‡•Ç‡§∑‡§ø‡§§', '‡§Ö‡§∏‡§Ç‡§®‡§æ‡§¶', '‡§∂‡§æ‡§™‡§ø‡§§',
    // Hindi Gen Z slang
    'cringe', 'fake', 'shady', 'sus', 'drama', 'mess', 'mid', 'flop', 'basic', 'salty',
    'lame', 'fail', 'boring', 'irritating', 'over', 'nope', 'chhapri', 'bakwas', 'thanda', 'ghatiya'
  ];

  // Normalize text for multilingual matching (lowercase, Unicode normalization)
  const textLower = text.toLowerCase().normalize('NFKC');

  // Count aura-related words
  const positiveWordCount = positiveAuraWords.reduce((count, word) => {
    return count + (textLower.includes(word.toLowerCase().normalize('NFKC')) ? 1 : 0);
  }, 0);
  const negativeWordCount = negativeAuraWords.reduce((count, word) => {
    return count + (textLower.includes(word.toLowerCase().normalize('NFKC')) ? 1 : 0);
  }, 0);

  // Calculate aura points
  let auraPoints = sentimentScore * 10; // Base: -50 to +50
  auraPoints += positiveWordCount * 15; // +15 per positive word
  auraPoints -= negativeWordCount * 15; // -15 per negative word
  auraPoints = Math.max(-100, Math.min(100, Math.round(auraPoints)));

  return auraPoints;
}

// Aura visualization function with multilingual flair
function visualizeAura(auraPoints, username) {
  let color, description, chakra, genZVibe, multilingualFlair;

  if (auraPoints > 50) {
    color = 'golden';
    description = `A radiant ${color} aura pulses around ${username}, shimmering with cosmic vibrations and high-vibrational energy. It flows like a divine light, emanating from the crown chakra, filled with starseed essence and pure bliss.`;
    chakra = 'crown chakra';
    genZVibe = 'main-character energy, serving highkey-iconic looks!';
    multilingualFlair = 'Radiating santhosham, ‡§ñ‡•Å‡§∂‡•Ä, and poli vibes!';
  } else if (auraPoints > 0) {
    color = 'blue';
    description = `A soothing ${color} aura surrounds ${username}, rippling with tranquility and empathic waves. It glows softly from the third-eye chakra, carrying a serene, uplifting vibration.`;
    chakra = 'third-eye chakra';
    genZVibe = 'vibe-check passed, giving aesthetic and soulful energy!';
    multilingualFlair = 'Flowing with shanthi, ‡§∂‡§æ‡§Ç‡§§‡§ø, and kidu energy!';
  } else if (auraPoints === 0) {
    color = 'white';
    description = `A neutral ${color} aura encircles ${username}, a balanced energy field with subtle etheric swirls. It resonates from the heart chakra, reflecting a calm, unaligned state.`;
    chakra = 'heart chakra';
    genZVibe = 'lowkey chill, just existing with no drama.';
    multilingualFlair = 'Balanced with aikyam, ‡§è‡§ï‡§§‡§æ, and nalla vibes.';
  } else if (auraPoints > -50) {
    color = 'grey';
    description = `A misty ${color} aura clings to ${username}, heavy with unaligned vibrations and faint dissonance. It stirs around the throat chakra, suggesting a need for clarity and expression.`;
    chakra = 'throat chakra';
    genZVibe = 'giving side-eye, slightly off-brand vibes.';
    multilingualFlair = 'Clouded by vishadam, ‡§â‡§¶‡§æ‡§∏‡•Ä, and chali energy.';
  } else {
    color = 'black';
    description = `A shadowy ${color} aura envelops ${username}, thick with karmic-debt and lower-vibration energy. It swirls chaotically around the root chakra, craving a spiritual cleanse.`;
    chakra = 'root chakra';
    genZVibe = 'big-yikes energy, total vibe-killer.';
    multilingualFlair = 'Heavy with veruppu, ‡§®‡§´‡§∞‡§§, and thallu vibes.';
  }

  return {
    embed: {
      title: `${username}'s Aura Visualization üåå`,
      description: `${description}\n\n**Chakra Alignment**: ${chakra}\n**Gen Z Vibe**: ${genZVibe}\n**Multilingual Vibe**: ${multilingualFlair}`,
      color: getEmbedColor(color),
      timestamp: new Date()
    }
  };
}

// Helper function to assign Discord embed colors
function getEmbedColor(auraColor) {
  const colorMap = {
    golden: 0xFFD700, // Gold
    blue: 0x00B7EB, // Sky Blue
    white: 0xFFFFFF, // White
    grey: 0x808080, // Grey
    black: 0x2F3136 // Dark (Discord dark theme)
  };
  return colorMap[auraColor] || 0x00B7EB; // Default to blue
}

// Bot ready event: Register slash commands and set status
client.once('ready', async () => {
  console.log(`Logged in as ${client.user.tag}`);
  await registerSlashCommands();

  // Set bot status to "Watching Aura"
  client.user.setPresence({
    activities: [{ name: 'Aura', type: ActivityType.Watching }],
    status: 'online'
  });
});

// Interaction event: Handle slash commands
client.on('interactionCreate', async (interaction) => {
  if (!interaction.isChatInputCommand()) return;

  const command = client.commands.get(interaction.commandName);
  if (!command) return;

  try {
    await command.execute(interaction);
  } catch (error) {
    console.error('Error executing slash command:', error);
    await interaction.reply({ content: 'An error occurred while executing the command.', ephemeral: true });
  }
});

// Message event: Process aura for non-command messages and handle prefix commands
client.on('messageCreate', async (message) => {
  if (message.author.bot || !message.content) return; // Ignore bots and empty messages

  const userId = message.author.id;
  const username = message.author.username;
  const text = message.content;

  try {
    // Handle ;aura command
    if (text.startsWith(';aura')) {
      const args = text.split(' ').slice(1);
      let targetUser;

      if (args.length === 0) {
        targetUser = message.author; // Default to message author
      } else {
        const userMention = args[0].match(/^<@!?(\d+)>$/);
        if (!userMention) {
          return message.reply('Please mention a valid user (e.g., ;aura @user).');
        }
        targetUser = await message.guild.members.fetch(userMention[1]).catch(() => null);
        if (!targetUser) {
          return message.reply('User not found in this server.');
        }
        targetUser = targetUser.user;
      }

      const targetUserData = await User.findOne({ userId: targetUser.id });
      if (!targetUserData || targetUserData.messageCount === 0) {
        return message.reply(`${targetUser.username} has no recorded aura yet.`);
      }

      // Generate aura description
      let auraDescription = '';
      if (targetUserData.auraPoints > 50) {
        auraDescription = 'Radiates positive energy (joy, love, compassion)';
      } else if (targetUserData.auraPoints > 0) {
        auraDescription = 'Mildly positive energy (uplifting, kind)';
      } else if (targetUserData.auraPoints === 0) {
        auraDescription = 'Neutral energy (balanced, no strong vibe)';
      } else if (targetUserData.auraPoints > -50) {
        auraDescription = 'Mildly negative energy (unsettled, low vibe)';
      } else {
        auraDescription = 'Radiates negative energy (toxic, dark)';
      }

      message.reply({
        embeds: [{
          title: `${targetUser.username}'s Aura Stats ‚ú®`,
          description: `**Aura Points**: ${targetUserData.auraPoints}\n**Vibe**: ${auraDescription}\n**Messages Analyzed**: ${targetUserData.messageCount}`,
          color: 0x00B7EB, // Blue
          timestamp: new Date()
        }]
      });
      return; // Skip aura analysis
    }

    // Handle ;visualize command
    if (text.startsWith(';visualize')) {
      const args = text.split(' ').slice(1);
      let targetUser;

      if (args.length === 0) {
        targetUser = message.author; // Default to message author
      } else {
        const userMention = args[0].match(/^<@!?(\d+)>$/);
        if (!userMention) {
          return message.reply('Please mention a valid user (e.g., ;visualize @user).');
        }
        targetUser = await message.guild.members.fetch(userMention[1]).catch(() => null);
        if (!targetUser) {
          return message.reply('User not found in this server.');
        }
        targetUser = targetUser.user;
      }

      const targetUserData = await User.findOne({ userId: targetUser.id });
      if (!targetUserData || targetUserData.messageCount === 0) {
        return message.reply(`${targetUser.username} has no recorded aura yet.`);
      }

      const visualization = visualizeAura(targetUserData.auraPoints, targetUser.username);
      message.reply({ embeds: [visualization.embed] });
      return; // Skip aura analysis
    }

    // Process aura for non-command messages
    const messageAuraPoints = calculateSpiritualAuraPoints(text);

    // Find or create user in database
    let user = await User.findOne({ userId });
    if (!user) {
      user = new User({
        userId,
        username,
        auraPoints: messageAuraPoints,
        messageCount: 1
      });
    } else {
      // Update aura: Weighted average to smooth fluctuations
      const newMessageCount = user.messageCount + 1;
      user.auraPoints = Math.round(
        (user.auraPoints * user.messageCount + messageAuraPoints) / newMessageCount
      );
      user.messageCount = newMessageCount;
      user.username = username; // Update username in case it changed
      user.lastUpdated = Date.now();
    }

    await user.save();
  } catch (error) {
    console.error('Error processing message:', error);
    message.reply('An error occurred while processing your aura.');
  }
});

// Login to Discord
client.login(process.env.DISCORD_TOKEN);